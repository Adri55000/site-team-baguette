{% extends "base.html" %}

{% block title %}
Live – {{ restream.title }}
{% endblock %}

{% block head %}
  {{ super() }}

  {# Tracker CSS : uniquement si éditeur+ et tracker actif #}
  {% if can_edit and tracker and tracker.frontend %}
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename=tracker.frontend.css) }}"
    >
  {% endif %}
{% endblock %}

{% block content %}

{% if can_edit and tracker and tracker.session %}
  <div class="container" style="margin-top: 18px;">
    <h2>Tracking</h2>

    {% if can_manage_tracker %}
      <div class="admin-actions" style="margin-bottom: 12px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-primary"
           href="{{ url_for('restream.restream_tracker_presets', slug=restream_slug) }}">
          Charger un preset
        </a>

        <form method="post"
              action="{{ url_for('restream.restream_tracker_reset', slug=restream_slug) }}"
              onsubmit="return confirm('Reset le tracker (preset par défaut) ?');">
          <button class="btn btn-danger" type="submit">Reset tracker</button>
        </form>
		
		{% if can_manage_tracker and tracker and tracker.session %}
		  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
			{% for p in tracker.session.participants %}
			  <form method="post"
					action="{{ url_for('restream.restream_toggle_final_time', slug=restream_slug, slot=p.slot) }}">
				<button class="btn {% if p.show_final_time %}btn-success{% else %}btn-secondary{% endif %}"
						type="submit">
				  Temps final J{{ p.slot }} : {% if p.show_final_time %}ON{% else %}OFF{% endif %}
				</button>
			  </form>
			{% endfor %}
		  </div>
		{% endif %}
      </div>
    {% endif %}

    {% include tracker.frontend.template_block %}


  </div>
{% endif %}

  {# Indices visibles pour tous #}
  {% if indices %}
    {% include "restream/_indices_block.html" %}
  {% endif %}

{% endblock %}

{% block scripts %}
  {{ super() }}

  {# Indices JS : uniquement si indices actifs #}
  {% if indices %}
    <script src="{{ url_for('static', filename='js/indices.js') }}"></script>
  {% endif %}

  {# Tracker JS : uniquement si éditeur+ et tracker actif #}
  {% if can_edit and tracker and tracker.frontend %}
    <script>
      window.TRACKER_CATALOG = {{ tracker.catalog | tojson }};
      window.TRACKER_STREAM_URL = {{ tracker.stream_url | tojson }};
    </script>
    <script src="{{ url_for('static', filename=tracker.frontend.js) }}"></script>
  {% endif %}
{% endblock %}
