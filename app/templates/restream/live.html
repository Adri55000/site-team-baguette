{% extends "base.html" %}

{% block title %}
{{ _("Live") }} – {{ restream.title }}
{% endblock %}

{% block head %}
  {{ super() }}

  {# Tracker CSS : uniquement si éditeur+ et tracker actif #}
  {% if can_edit and tracker and tracker.frontend %}
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename=tracker.frontend.css) }}"
    >
  {% endif %}
{% endblock %}

{% block content %}

{% if can_edit and tracker and tracker.session %}
  <div class="container" style="margin-top: 18px;">
    <h2>{{ _("Tracking") }}</h2>

    {% if can_manage_tracker %}
	  <section class="live-actions">

		<div class="live-actions__left">
		  <a class="btn btn-primary"
			 href="{{ url_for('restream.restream_tracker_presets', slug=restream_slug) }}">
			{{ _("Charger un preset") }}
		  </a>

		  <form method="post"
				action="{{ url_for('restream.restream_tracker_reset', slug=restream_slug) }}"
				onsubmit="return confirm('Reset le tracker (preset par défaut) ?');">
			<button class="btn btn-danger" type="submit">{{ _("Reset tracker") }}</button>
		  </form>

		  {% if tracker and tracker.session %}
			<div class="live-actions__toggles">
			  {% for p in tracker.session.participants %}
				<form method="post"
					  action="{{ url_for('restream.restream_toggle_final_time', slug=restream_slug, slot=p.slot) }}">
				  <button class="btn {% if p.show_final_time %}btn-success{% else %}btn-secondary{% endif %}"
						  type="submit">
					{{ _("Temps final J%(slot)s : %(state)s", slot=p.slot, state=_("ON") if p.show_final_time else _("OFF")) }}
				  </button>
				</form>
			  {% endfor %}
			</div>
		  {% endif %}
		</div>

		<form method="post"
			  action="{{ url_for('restream.live_set_room_racetime', slug=restream.slug) }}"
			  class="live-actions__racetime">
		  <label class="live-actions__label" for="racetime_room">{{ _("Room racetime") }}</label>

		  <input
			id="racetime_room"
			name="racetime_room"
			type="text"
			value="{{ match.racetime_room or '' }}"
			placeholder="https://racetime.gg/lozssr/cunning-crystals-3960"
			autocomplete="off"
			spellcheck="false"
		  >

		  <button type="submit" class="btn btn-secondary">{{ _("Enregistrer") }}</button>
		</form>

	  </section>
	{% endif %}

    {% include tracker.frontend.template_block %}


  </div>
{% endif %}

  {# Indices visibles pour tous #}
  {% if indices %}
    {% include "restream/_indices_block.html" %}
  {% endif %}

{% endblock %}

{% block scripts %}
  {{ super() }}

  {# Indices JS : uniquement si indices actifs #}
  {% if indices %}
    <script src="{{ url_for('static', filename='js/indices.js') }}"></script>
  {% endif %}

  {# Tracker JS : uniquement si éditeur+ et tracker actif #}
  {% if can_edit and tracker and tracker.frontend %}
    <script>
      window.TRACKER_CATALOG = {{ tracker.catalog | tojson }};
      window.TRACKER_STREAM_URL = {{ tracker.stream_url | tojson }};
    </script>
    <script src="{{ url_for('static', filename=tracker.frontend.js) }}"></script>
  {% endif %}
{% endblock %}
