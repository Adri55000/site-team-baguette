{% extends "base.html" %}
{% block title %}{{ _("Gérer les matchs") }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-dashboard">

<h1>{{ _("Gérer les matchs") }}</h1>

<!-- Sélection du tournoi -->
<div class="admin-card admin-user-toolbar">
    <form method="get" action="{{ url_for('admin.admin_matches') }}">
        <select name="tournament_id" required>
            <option value="">— {{ _("Sélectionner un tournoi") }} —</option>
            {% for t in tournaments %}
                <option value="{{ t.id }}"
                    {% if selected_tournament and t.id == selected_tournament.id %}selected{% endif %}>
                    {{ t.name }}
                </option>
            {% endfor %}
        </select>
		{% if selected_tournament %}
			<select name="phase_id">
				<option value="">— {{ _("Toutes les phases") }} —</option>
				{% for p in phases %}
					<option value="{{ p.id }}"
						{% if selected_phase_id and p.id == selected_phase_id %}selected{% endif %}>
						{{ p.position }}. {{ p.name }}
					</option>
				{% endfor %}
			</select>
		{% endif %}

        <button class="btn">{{ _("Afficher") }}</button>
    </form>
</div>

{% if selected_tournament %}
<p class="admin-subtitle">
    {{ _("Tournoi :") }} <strong>{{ selected_tournament.name }}</strong>
</p>

<!-- Actions -->
<div class="admin-actions-toolbar">
    {% if selected_tournament.status != "finished" %}
        <a class="btn btn-primary"
           href="{{ url_for('admin.admin_confrontation_create',
                            tournament_id=selected_tournament.id, phase_id=selected_phase_id) }}">
            {{ _("Nouvelle confrontation") }}
        </a>

        <a class="btn btn-secondary"
           href="{{ url_for('admin.admin_match_create',
                            tournament_id=selected_tournament.id) }}">
            {{ _("Nouveau tie-break") }}
        </a>
    {% endif %}
</div>

<!-- Confrontations -->
<div class="admin-card">
<h2>{{ _("Confrontations") }}</h2>

<table class="admin-table">
<thead>
<tr>
    <th>{{ _("Équipes") }}</th>
    <th>{{ _("Stage") }}</th>
	<th>{{ _("Round") }}</th>
    <th>{{ _("BO") }}</th>
    <th>{{ _("Progression") }}</th>
    <th class="actions">{{ _("Actions") }}</th>
</tr>
</thead>

<tbody>
{% if confrontations %}
    {% set ns = namespace(current_phase=None) %}
	{% for c in confrontations %}
        {% set wins = c.matches_played or 0 %}

        {% if ns.current_phase != c.phase_id %}
			{% set ns.current_phase = c.phase_id %}
			<tr class="admin-phase-header" data-phase="{{ c.phase_id }}">
				<td colspan="6">
					<strong>
						{{ _("Phase") }} {{ c.phase_position }} — {{ c.phase_name }}
					</strong>
				</td>
			</tr>
		{% endif %}

        <tr class="admin-confrontation-row"
            data-phase="{{ c.phase_id }}">
            <td>
                <div>
                    {{ c.team1_name | team_name }} vs {{ c.team2_name | team_name }}
                </div>

                <div class="text-muted">
                    BO{{ c.best_of }} — {{ c.team1_wins or 0 }} – {{ c.team2_wins or 0 }}
                </div>

                <div class="text-muted">
                    {{ ngettext(
						"%(wins)s victoire sur %(total)s",
						"%(wins)s victoires sur %(total)s",
						wins
					) | format(wins=wins, total=c.best_of) }}
                </div>

                <div class="admin-series-status">
                    {% if c.match_count == 0 %}
                        <span class="badge badge-muted">{{ _("Aucun match") }}</span>
                    {% elif c.winner_team_id %}
                        <span class="badge badge-success">{{ _("Confrontation gagnée") }}</span>
                    {% else %}
                        <span class="badge badge-warning">{{ _("Confrontation en cours") }}</span>
                    {% endif %}
                </div>

                {% if c.winner_team_id %}
                <div class="text-muted">
                    {{ _("Vainqueur :") }}
                    <span class="badge badge-success">
                        {{ c.winner_name | team_name }}
                    </span>
                </div>
                {% endif %}
            </td>

            <td>{{ c.stage or "—" }}</td>
			<td>{{ c.round if c.round is not none else "—" }}</td>
            <td>BO{{ c.best_of }}</td>

            <td>
                <span class="text-muted">
                    {{ wins }} / {{ c.match_count }}
                    {{ ngettext(
						"%(count)s match joué",
						"%(count)s matchs joués",
						c.match_count
					) | format(count=c.match_count) }}

                </span>
            </td>

            <td class="actions">
                <a class="btn btn-secondary-small"
                   href="{{ url_for('admin.admin_confrontation_matches',
                                    series_id=c.id) }}">
                    {{ _("Gérer les matchs") }}
                </a>

                {% if selected_tournament.status != "finished" %}
                    <a class="btn btn-secondary-small"
                       href="{{ url_for('admin.admin_confrontation_edit',
                                        series_id=c.id) }}">
                        {{ _("Modifier") }}
                    </a>

                    {% if c.match_count == 0 %}
                    <form method="post"
                          action="{{ url_for('admin.admin_confrontation_delete',
                                             series_id=c.id) }}"
                          class="inline-form">
                        <button class="btn btn-danger-small"
                                onclick="return confirm('Supprimer cette confrontation ?')">
                            {{ _("Supprimer") }}
                        </button>
                    </form>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
    {% endfor %}
{% else %}
    <tr>
        <td colspan="6" class="admin-empty">
            {{ _("Aucune confrontation pour ce tournoi.") }}
        </td>
    </tr>
{% endif %}
</tbody>
</table>
</div>

<!-- Tie-breaks -->
<div class="admin-card">
<h2>{{ _("Tie-breaks / matchs indépendants") }}</h2>

<table class="admin-table">
<thead>
<tr>
    <th>{{ _("ID") }}</th>
    <th>{{ _("Date") }}</th>
    <th>{{ _("Statut") }}</th>
    <th class="actions">{{ _("Actions") }}</th>
</tr>
</thead>

<tbody>
{% if tiebreaks %}
    {% for m in tiebreaks %}
    <tr>
        <td>#{{ m.id }}</td>
        <td>
            {{ m.scheduled_at[:16].replace("T", " ") if m.scheduled_at else "—" }}
        </td>
        <td>
            {% if m.is_completed %}
                <span class="badge badge-success">{{ _("Terminé") }}</span>
            {% else %}
                <span class="badge badge-muted">{{ _("À jouer") }}</span>
            {% endif %}
        </td>
        <td class="actions">
            <a class="btn btn-primary-small"
               href="{{ url_for('admin.admin_match_results', match_id=m.id) }}">
                {{ _("Saisir les résultats") }}
            </a>
            <a class="btn btn-secondary-small"
               href="{{ url_for('admin.admin_match_edit', match_id=m.id) }}">
                {{ _("Modifier") }}
            </a>
            {% if selected_tournament.status != "finished" and not m.is_completed %}
            <form method="post"
                  action="{{ url_for('admin.admin_match_delete', match_id=m.id) }}"
                  class="inline-form">
                <button class="btn btn-danger-small"
                        onclick="return confirm('Supprimer ce tie-break ?')">
                    {{ _("Supprimer") }}
                </button>
            </form>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
{% else %}
    <tr>
        <td colspan="4" class="admin-empty">
            {{ _("Aucun tie-break.") }}
        </td>
    </tr>
{% endif %}
</tbody>
</table>
</div>

{% endif %}
</div>
{% endblock %}
